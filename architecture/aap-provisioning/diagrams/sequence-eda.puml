@startuml EDA Model - Deletion During Provisioning
skinparam scale 2
skinparam padding 10
skinparam ParticipantPadding 20
skinparam BoxPadding 10

skinparam backgroundColor white
skinparam sequenceMessageAlign center

actor User
participant "fulfillment-cli" as CLI
participant "fulfillment-service" as Service
participant "Kubernetes API" as K8s
participant "cloudkit-operator" as Operator
participant "AAP Webhook" as AAP
participant "Provision Playbook" as ProvPlay
participant "Deprovision Playbook" as DeprovPlay

== Creation Phase ==
User -> CLI: create computeinstance
CLI -> Service: CreateComputeInstance(template, params)
Service -> K8s: Create ComputeInstance CR
K8s --> Service: CR created
Service --> CLI: UUID

Operator -> K8s: Watch CR (created event)
Operator -> AAP: POST /webhook (provision)
AAP -> ProvPlay: Launch job
ProvPlay -> ProvPlay: Set AAP finalizer on CR
note right: AAP sets its own finalizer\nto manage cleanup
ProvPlay -> ProvPlay: Provision VM
AAP --> Operator: 202 Accepted

== Deletion During Provisioning ==
User -> CLI: delete computeinstance <uuid>
CLI -> Service: DeleteComputeInstance(uuid)
Service -> K8s: Set deletionTimestamp on CR
K8s --> Service: Updated

Operator -> K8s: Watch CR (updated event, deletionTimestamp set)
Operator -> Operator: Check finalizers
note right: Only proceed if\nAAP finalizer exists

alt AAP Finalizer Exists
    Operator -> AAP: POST /webhook (deprovision)
    AAP -> DeprovPlay: Launch job
    DeprovPlay -> DeprovPlay: Cleanup VM
    DeprovPlay -> DeprovPlay: Remove AAP finalizer
    AAP --> Operator: 202 Accepted

    note over Operator: Provision job may still be running\nAAP handles cancellation internally

    Operator -> Operator: Remove operator finalizer
    Operator -> K8s: Remove finalizer from CR
    K8s -> K8s: Delete CR (no finalizers remain)
else AAP Finalizer Missing
    note over Operator: Skip deprovision\nNo AAP job was started
    Operator -> Operator: Remove operator finalizer
    Operator -> K8s: Remove finalizer from CR
    K8s -> K8s: Delete CR
end


||||

@enduml
