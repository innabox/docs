@startuml AAP Direct Model - Creation and Provisioning
skinparam scale 2
skinparam padding 20
skinparam ParticipantPadding 30
skinparam BoxPadding 20

skinparam backgroundColor white
skinparam sequenceMessageAlign center
skinparam maxMessageSize 150

actor User
participant "fulfillment-cli" as CLI
participant "fulfillment-service" as Service
participant "Kubernetes API" as K8s
participant "cloudkit-operator" as Operator
participant "AAP REST API" as AAP

== Creation Phase ==
User -> CLI: create computeinstance
CLI -> Service: CreateComputeInstance(template, params)
Service -> K8s: Create ComputeInstance CR
K8s --> Service: CR created
Service --> CLI: UUID

Operator -> K8s: Watch CR (created event)
Operator -> Operator: Add operator finalizer
Operator -> K8s: Update CR with finalizer

== Provisioning Phase ==
Operator -> AAP: POST /api/controller/jobs/\n{template: provision, extra_vars}
AAP --> Operator: 201 Created {id: 4870}
Operator -> Operator: Set status:\nprovisionJobID=4870\nprovisionJobState=Pending
Operator -> K8s: Update CR status
note right: **Idempotency:** Job ID persisted\nimmediately to prevent\nduplicate triggers

loop Poll Provision Status (every 30s)
    Operator -> AAP: GET /api/controller/jobs/4870/
    AAP --> Operator: {id: 4870, status: running}
    Operator -> Operator: Update status:\nprovisionJobState=Running
    Operator -> K8s: Update CR status
end

Operator -> AAP: GET /api/controller/jobs/4870/
AAP --> Operator: {id: 4870, status: successful}
Operator -> Operator: Update status:\nprovisionJobState=Succeeded\nphase=Ready
Operator -> K8s: Update CR status

note over Operator, AAP
  **AAP Direct Creation:**
  - Operator calls REST API directly
  - Job ID stored immediately
  - Status polled periodically
  - No AAP-managed finalizer
end note

||||
||||
||||
||||
||||

@enduml
